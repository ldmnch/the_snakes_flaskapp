{% extends "base.html" %}

{% block content %}
  <div class="game-wrapper">
    <h2><span class="emoji">üêç</span> Maze Challenge</h2>
    <p id="instructions" class="instructions">Use W, A, S and D to move throuh the maze. Reach the green square to win!</p>
    <p id="statusMessage" class="top-status"></p>
    <div id="canvas-container"> {# Optional container for positioning #}
        <canvas id="gameCanvas"></canvas>
    </div>
    <div class="controls">
        <button id="generate-maze-btn" class="maze-btn">Generate New Maze</button>
        <select id="mazeSizeSelect">
            <option value="3">Small (3x3)</option>
            <option value="5" selected>Medium (5x5)</option>
            <option value="7">Large (7x7)</option>
            <option value="10">Extra Large (10x10)</option>
            <option value="15">Very Large (15x15)</option>
            <option value="20">XXL (20x20)</option>
        </select>
        <button id="solve-maze-btn" class="maze-btn">Solve Maze</button>
    </div>
  </div>

  <style>
      body {
          text-align: center;
          display: flex;
          flex-direction: column;
          align-items: center;
          min-height: 100vh;
          margin: 0;
      }

      .game-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        margin-top: 1rem;
        width: 100%;
        max-width: 1400px;
        padding: 0 1rem;
        box-sizing: border-box;
      }

      #canvas-container {
        line-height: 0;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #gameCanvas {
          display: block;
          max-width: 95vw;
          max-height: 80vh;
          border: 2px solid white;
          background-color: white;
      }

      .controls {
          margin-top: 15px;
      }
      .maze-btn {
          padding: 0.6rem 1.2rem;
          font-weight: 600;
          border-radius: 1rem;
          border: none;
          background-color: white;
          color: black;
          cursor: pointer;
          margin: 0.5rem;
          font-family: 'Poppins', sans-serif;
      }
      .maze-btn:hover {
          background-color: #eee;
      }
      #statusMessage {
          font-size: 18px;
          font-weight: bold;
          margin-top: 5px;
          color: lightgreen;
          min-height: 27px;
      }
      #instructions {
          font-size: 14px;
          font-weight: normal;
          margin-top: 5px;
          color: white;
          min-height: 27px;
      }
       .emoji {
          font-size: 2rem;
          margin-right: 0.3rem;
      }
      .top-status {
        margin-bottom: 10px;
      }
  </style>

  <script>
      let trophyImg;

      function preloadTrophyImage(){
        trophyImg = new Image();
        trophyImg.src = "/static/winnertrophy.png";
        trophyImg.onload = () => {
            console.log("Trophy image loaded!");
        };
        trophyImg.onerror = () => {
            console.error("Error loading trophy image.");
        };
      }
      preloadTrophyImage();

      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const newMazeBtn = document.getElementById("generate-maze-btn");
      const solveMazeBtn = document.getElementById("solve-maze-btn");
      const mazeSizeSelect = document.getElementById("mazeSizeSelect");
      const statusMessage = document.getElementById("statusMessage");
      const controlsDiv = document.querySelector('.controls');
      const titleH2 = document.querySelector('h2');

      let tileSize = 10;
      let maze = [];
      let player = { x: 1, y: 1 };
      let goal = { x: 1, y: 1 }; // Set dynamically
      let solutionPath = []; // Stores the path to solve the maze

      function drawMaze() {
          if (!maze || maze.length === 0 || !maze[0]) return;

          const vh = window.innerHeight;
          const vw = window.innerWidth;
          const controlsHeight = controlsDiv.offsetHeight || 60;
          const titleHeight = titleH2.offsetHeight || 40;
          const verticalPadding = 60;
          const horizontalPadding = 40;

          const availableHeight = vh - controlsHeight - titleHeight - verticalPadding;
          const availableWidth = Math.min(vw - horizontalPadding, 1400 - horizontalPadding);

          const tileWidthBased = Math.floor(availableWidth / maze[0].length);
          const tileHeightBased = Math.floor(availableHeight / maze.length);
          tileSize = Math.max(1, Math.min(tileWidthBased, tileHeightBased));

          canvas.width = tileSize * maze[0].length;
          canvas.height = tileSize * maze.length;

          ctx.clearRect(0, 0, canvas.width, canvas.height);

          for (let row = 0; row < maze.length; row++) {
              for (let col = 0; col < maze[row].length; col++) {
                  const drawX = col * tileSize;
                  const drawY = row * tileSize;

                  if (maze[row][col] === 1) {
                      ctx.fillStyle = "black"; // Walls
                  } else if (row === goal.y && col === goal.x) {
                      ctx.fillStyle = "green"; // Goal
                  } else {
                      ctx.fillStyle = "white"; // Open path
                  }
                  ctx.fillRect(drawX, drawY, tileSize, tileSize);
              }
          }

          ctx.fillStyle = "blue";
          solutionPath.forEach(([x, y]) => {
              ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
          });

          ctx.fillStyle = "red";
          ctx.fillRect(player.x * tileSize, player.y * tileSize, tileSize, tileSize);
      }

      function findStartPosition() {
          for (let y = 0; y < maze.length; y++) {
              for (let x = 0; x < maze[y].length; x++) {
                  if (maze[y][x] === 0) { return { x: x, y: y }; }
              }
          }
          return { x: 1, y: 1 };
      }

      function findGoalPosition() {
          if (!maze || maze.length === 0 || !maze[0]) return { x: 1, y: 1 };
          for (let y = maze.length - 1; y >= 0; y--) {
              for (let x = maze[y].length - 1; x >= 0; x--) {
                  if (maze[y][x] === 0) { return { x: x, y: y }; }
              }
          }
          return { x: Math.max(1, maze[0].length - 2), y: Math.max(1, maze.length - 2) };
      }

      function preloadTrophyImage() {
        trophyImg = new Image();
        trophyImg.src = "/static/winnertrophy.png";  // Adjust the path if necessary
        trophyImg.onload = () => {
            console.log("Trophy image loaded successfully!");
        };
        trophyImg.onerror = () => {
            console.error("Error loading trophy image.");
        };
    }

      function loadMaze(dimension) {
          statusMessage.textContent = "Loading Maze...";
          fetch(`/api/generate_maze/${dimension}`)
              .then(response => {
                  if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                  return response.json();
              })
              .then(data => {
                  maze = data;
                  if (!maze || maze.length === 0 || !maze[0]) {
                      console.error("Invalid maze data received");
                      maze = [[1,1,1],[1,0,1],[1,1,1]];
                  }
                  player = findStartPosition();
                  goal = findGoalPosition();
                  solutionPath = []; // Clear any previous solution
                  statusMessage.textContent = ""; // Clear success message
                  drawMaze();
              })
              .catch(error => {
                  console.error("Error loading maze:", error);
                  statusMessage.textContent = `Error loading maze: ${error.message}`;
                  maze = [];
                  ctx.clearRect(0, 0, canvas.width, canvas.height);
              });

              let instructions = document.getElementById("instructions");
              if (!instructions) { // Create new instructions if they don't exist
                  instructions = document.createElement("p");
                  instructions.id = "instructions";
                  instructions.className = "instructions";
                  instructions.textContent = "Use W, A, S and D to move through the maze. Reach the green square to win!";
                  
                  const gameWrapper = document.querySelector(".game-wrapper");
                  gameWrapper.insertBefore(instructions, statusMessage);
                } else {
                    instructions.style.display = "block";
                }
      }

      function movePlayer(dx, dy) {
          if (!maze || maze.length === 0 || statusMessage.textContent.includes("üéâ")) return;

          let newX = player.x + dx;
          let newY = player.y + dy;

          if (maze[newY] && typeof maze[newY][newX] !== 'undefined' && maze[newY][newX] === 0) {
              player.x = newX;
              player.y = newY;
              drawMaze();

              if (player.x === goal.x && player.y === goal.y) {
                  statusMessage.textContent = "üéâYou reached the exit! Well done!üéâ ";
                  drawTrophy(player.x, player.y); // Displays trophy after winning.
                  removeInstructions(); // Removes instructions once player wins.
                }
          }
      }

      // After movePlayer notice, so when the player reaches the matching solution, a trophy is rendered

      function drawTrophy(x, y) {

        if (trophyImg && trophyImg.complete){
            ctx.drawImage(trophyImg, x * tileSize, y * tileSize, tileSize, tileSize);
        } 
        else{
            console.error("Trophy image not loaded.")
        }
      }

      function removeInstructions(){
        const instructions = document.getElementById("instructions");
        if (instructions){
            instructions.remove(); // Completely remove the element
        }
      }

      async function solveMaze() {
          if (!maze || maze.length === 0) return;

          statusMessage.textContent = "Solving...";
          solutionPath = [];

          try {
              const response = await fetch('/api/solve_maze', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ maze: maze, start: player, goal: goal })
              });

              if (!response.ok) {
                  const err = await response.json().catch(() => ({ error: `Server error ${response.status}` }));
                  throw new Error(err.error || `Server error ${response.status}`);
              }

              const result = await response.json();

              if (result.path && result.path.length > 0) {
                  solutionPath = result.path;
                  statusMessage.textContent = "Solution found!";
              } else {
                  statusMessage.textContent = "‚ùå No solution found!";
              }
          } catch (error) {
              console.error("Solve API Error:", error);
              statusMessage.textContent = `Error: ${error.message}`;
          } finally {
               drawMaze();
          }
      }

      document.addEventListener("keydown", function (event) {
          if (statusMessage.textContent.includes("üéâ")) return;

          const moves = {
            "ArrowUp": [0, -1], "w": [0, -1], "ArrowDown": [0, 1], "s": [0, 1],
            "ArrowLeft": [-1, 0], "a": [-1, 0], "ArrowRight": [1, 0], "d": [1, 0]
          };
          if (moves[event.key]) {
              event.preventDefault();
              movePlayer(...moves[event.key]);
          }
           if (event.key === 'e') {
               event.preventDefault();
               solveMaze();
           }
      });

      newMazeBtn.addEventListener("click", function () {
          loadMaze(parseInt(mazeSizeSelect.value));
      });

      solveMazeBtn.addEventListener("click", solveMaze);

      function debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
              const later = () => {
                  clearTimeout(timeout);
                  func(...args);
              };
              clearTimeout(timeout);
              timeout = setTimeout(later, wait);
          };
      };

      function drawTrophy(x, y) {
        if (trophyImg.complete) {
            ctx.drawImage(trophyImg, x * tileSize, y * tileSize, tileSize, tileSize);
        } 
        else {
        console.error("Trophy image not loaded.");  
        }
}

      const debouncedDrawMaze = debounce(() => {
          if (maze && maze.length > 0) {
             drawMaze();
          }
      }, 150);

      window.addEventListener('resize', debouncedDrawMaze);

      loadMaze(parseInt(mazeSizeSelect.value || '5'));

  </script>
{% endblock %}